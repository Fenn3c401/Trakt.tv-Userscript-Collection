// ==UserScript==
// @name         Trakt.tv | Charts - Seasons
// @description  Adds a line chart to /seasons pages which shows the ratings (personal + general) and the number of watchers and comments for each individual episode. See README for details.
// @version      0.1.5
// @namespace    https://github.com/Fenn3c401
// @author       Fenn3c401
// @license      GPL-3.0-or-later
// @homepageURL  https://github.com/Fenn3c401/Trakt.tv-Userscript-Collection#readme
// @supportURL   https://github.com/Fenn3c401/Trakt.tv-Userscript-Collection/issues
// @updateURL    https://update.greasyfork.org/scripts/550072.meta.js
// @downloadURL  https://raw.githubusercontent.com/Fenn3c401/Trakt.tv-Userscript-Collection/main/userscripts/dist/cs1u5z40.min.user.js
// @icon         https://trakt.tv/assets/logos/logomark.square.gradient-b644b16c38ff775861b4b1f58c1230f6a097a2466ab33ae00445a505c33fcb91.svg
// @match        https://trakt.tv/*
// @match        https://classic.trakt.tv/*
// @run-at       document-start
// @require      https://cdn.jsdelivr.net/npm/chart.js@4.4.9/dist/chart.umd.min.js
// @require      https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.2.0/dist/chartjs-plugin-zoom.min.js
// @grant        unsafeWindow
// @grant        GM_addStyle
// @grant        GM_openInTab
// ==/UserScript==

/* README
### General
- Clicking on the individual data points takes you to the summary page of the respective episode (or the comment page for comment data points).
- For charts with more than eight episodes, you can also zoom in by highlighting a section of the x-axis with your mouse. You can zoom out again by clicking anywhere inside the chart.
- This script won't work (well) on mobile devices and the chart is no beauty on light mode either. Basically the whole thing needs an overhaul and is not even close to being finished,
    but the core functionality is there and it might be while until I get back to it, which is why I'm putting it out there as it is right now.
*/


"use strict";let $,traktApiModule,$grid,isSeasonChart,filterSpecials,labelsCallback,chart,datasetsData,firstRunDelay;Chart.defaults.borderColor="rgb(44 44 44 / 0.5)";const numFormatCompact=new Intl.NumberFormat("en",{notation:"compact",maximumFractionDigits:1});numFormatCompact.formatTLC=e=>numFormatCompact.format(e).toLowerCase(),addStyles(),document.addEventListener("turbo:load",async()=>{/^\/shows\/[^/]+\/seasons\/[^/]+$/.test(location.pathname)&&($??=unsafeWindow.jQuery,traktApiModule??=unsafeWindow.userscriptTraktApiModule?.isFulfilled?await unsafeWindow.userscriptTraktApiModule:null,$&&($grid=$("#seasons-episodes-sortable"),$grid.length&&(isSeasonChart=location.pathname.includes("/seasons/"),filterSpecials=!location.pathname.includes("/seasons/0"),labelsCallback=isSeasonChart?e=>`${e.seasonNum}x${String(e.episodeNum).padStart(2,"0")} ${e.watched?"\u2714":"\u2718"}`:e=>`S. ${e.seasonNum} ${e.watched?e.watched==100?"\u2714":`(${e.watched}%)`:"\u2718"}`,chart=null,datasetsData=[],firstRunDelay=!0,!(!isSeasonChart&&+$(".season-count").text().split(" ")[0]<4||location.pathname.includes("/alternate/")&&location.pathname.split("/").filter(Boolean).length<6)&&($grid.on("arrangeComplete",()=>{$grid.data("isotope")&&(chart?updateChart():initializeChart())}),$(document).off("ajaxSuccess.userscript48372").on("ajaxSuccess.userscript48372",(e,t,a)=>{a.url.includes("/rate")&&chart&&updateChart()})))))},{capture:!0});function initializeChart(){const e=$('<div id="seasons-episodes-chart-wrapper"><canvas></canvas></div>').insertBefore($grid).children()[0];chart=new Chart(e.getContext("2d"),{type:"line",data:getChartData(),options:getChartOptions()});const t=new IntersectionObserver(a=>{a.forEach(r=>{r.isIntersecting&&(t.disconnect(),document.hidden?$(document).one("visibilitychange",updateChart):updateChart())})},{threshold:1});t.observe(e),e.addEventListener("click",a=>{const r=chart.getElementsAtEventForMode(a,"nearest",{axis:"x",intersect:!1},!0);if(!r.length)return;const s=r.sort((n,o)=>Math.abs(n.element.y-a.layerY)-Math.abs(o.element.y-a.layerY))[0];if(Math.abs(s.element.y-a.layerY)<10){const n=`${datasetsData[s.index].urlFull}${s.datasetIndex===3?"/comments":""}`;GM_openInTab(n,{active:!0})}else chart.isZoomedOrPanned()&&chart.resetZoom("active")})}async function updateChart(){const e=await getDatasetsData();JSON.stringify(datasetsData)!==JSON.stringify(e)&&(datasetsData=e,chart.data=getChartData(),chart.options=getChartOptions(),chart.update(),firstRunDelay&&(firstRunDelay=!1))}function getDatasetsData(){const e=$grid.data("isotope").filteredItems.filter(t=>filterSpecials?t.element.dataset.seasonNumber!=="0":!0).map(async t=>{const a={generalRating:t.sortData.percentage,votes:t.sortData.votes,watchers:t.sortData.watchers,episodeNum:t.element.dataset.number||null,seasonNum:t.element.dataset.seasonNumber,urlFull:$(t.element).find('meta[itemprop="url"]').attr("content"),personalRating:$(t.element).find(".corner-rating > .text").text()||null,watched:$(t.element).find("a.watch.selected").attr("data-percentage")??0,releaseDate:$(t.element).find(".percentage").attr("data-earliest-release-date")};if(isSeasonChart)a.mainTitle=$(t.element).find(".under-info .main-title").text(),a.comments=$(t.element).find('.episode-stats > a[data-original-title="Comments"]').text()||0;else if(a.mainTitle=$(t.element).find('div[data-type="season"] .titles-link h3').text(),traktApiModule){const r=await traktApiModule.seasons.comments({id:t.element.dataset.showId,season:a.seasonNum,pagination:!0,limit:1});a.comments=r.pagination.item_count}else{const r=await fetch(t.element.dataset.url+".json");if(!r.ok)throw new Error(`XHR for: ${r.url} failed with status: ${r.status}`);a.comments=(await r.json()).stats.comment_count}return a});return Promise.all(isSeasonChart?e:e.reverse())}function getGradientY(e,t,a,...r){if(!e)return r.pop().color;const{ctx:s,chartArea:n,scales:o}=e.chart;if(n){if(s[t]??={},!s[t].gradient||s[t].height!==n.height||s[t].yAxisMin!==o[a].min||s[t].yAxisMax!==o[a].max){s[t].height=n.height,s[t].yAxisMin=o[a].min,s[t].yAxisMax=o[a].max;let i=o[a].max-o[a].min;i=i?o[a].max/i:1,i=n.bottom*i,s[t].gradient=s.createLinearGradient(0,i,0,n.top),r.forEach(l=>s[t].gradient.addColorStop(l.offset,l.color))}return s[t].gradient}}function getChartData(){return{labels:datasetsData.map(labelsCallback),datasets:[{label:"Personal Rating",data:datasetsData.map(e=>e.personalRating?e.personalRating*10:null),yAxisID:"yAxisRating",borderColor:e=>getGradientY(e,"_ratingPersonal","yAxisRating",{offset:0,color:"rgb(97 97 97 / 0.6)"},{offset:.1,color:"rgb(97 97 97 / 0.6)"},{offset:1,color:"rgb(175 2 0)"}),backgroundColor:e=>getGradientY(e,"_ratingPersonal","yAxisRating",{offset:0,color:"rgb(97 97 97 / 0.6)"},{offset:.1,color:"rgb(97 97 97 / 0.6)"},{offset:1,color:"rgb(175 2 0)"})},{label:"General Rating",data:datasetsData.map(e=>e.generalRating),yAxisID:"yAxisRating",fill:{target:"-1",above:`rgb(255 0 0 / ${$("body").hasClass("dark-knight")?.15:.3})`,below:`rgb(0 255 0 / ${$("body").hasClass("dark-knight")?.15:.3})`},borderColor:e=>getGradientY(e,"_ratingGeneral","yAxisRating",{offset:0,color:"rgb(97 97 97 / 0.6)"},{offset:.1,color:"rgb(97 97 97 / 0.6)"},{offset:1,color:"rgb(225 31 117)"}),backgroundColor:e=>getGradientY(e,"_ratingGeneral","yAxisRating",{offset:0,color:"rgb(97 97 97 / 0.6)"},{offset:.1,color:"rgb(97 97 97 / 0.6)"},{offset:1,color:"rgb(225 31 117)"})},{label:"Watchers",data:datasetsData.map(e=>e.watchers),yAxisID:"yAxisWatchers",borderColor:e=>getGradientY(e,"_watchers","yAxisWatchers",{offset:0,color:"rgb(154 67 201 / 0.2)"},{offset:1,color:"rgb(154 67 201)"}),backgroundColor:e=>getGradientY(e,"_watchers","yAxisWatchers",{offset:0,color:"rgb(154 67 201 / 0.2)"},{offset:1,color:"rgb(154 67 201)"})},{label:"Comments",data:datasetsData.map(e=>e.comments),yAxisID:"yAxisComments",borderColor:e=>getGradientY(e,"_comments","yAxisComments",{offset:0,color:"rgb(54 157 226 / 0.2)"},{offset:1,color:"rgb(54 157 226)"}),backgroundColor:e=>getGradientY(e,"_comments","yAxisComments",{offset:0,color:"rgb(54 157 226 / 0.2)"},{offset:1,color:"rgb(54 157 226)"})}]}}function getChartOptions(){return{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"nearest",axis:"x",intersect:!1},animation:{delay:e=>e.type==="data"&&e.mode==="default"?(firstRunDelay?500:0)+e.dataIndex*(750/Math.max(datasetsData.length-1,1))+e.datasetIndex*100:0},scales:{x:{offset:!0},yAxisRating:{type:"linear",position:"left",offset:!0,suggestedMin:60,max:100,title:{display:!0,text:"Rating"},grid:{color:e=>e.tick.value%10?Chart.defaults.borderColor:"rgb(55 55 55)"},ticks:{callback:e=>`${e}%`}},yAxisWatchers:{type:"linear",position:"right",offset:!0,min:0,suggestedMax:10,title:{display:!0,text:"Watchers"},grid:{drawOnChartArea:!1},ticks:{callback:e=>numFormatCompact.formatTLC(e)}},yAxisComments:{type:"linear",position:"right",offset:!0,min:0,suggestedMax:10,title:{display:!0,text:"Comments"},grid:{drawOnChartArea:!1}}},plugins:{tooltip:{usePointStyle:!0,boxPadding:5,backgroundColor:"rgb(0 0 0 / 0.5)",caretSize:10,padding:{x:18,y:6},titleFont:{size:13,weight:"bold"},callbacks:{title:e=>{let t=datasetsData[e[0].parsed.x].mainTitle;return t=t.length>20?t.slice(0,20).trim()+"...":t,`${e[0].label}${t?`
${t}`:""}`},label:e=>{const t=e.parsed.x,a=e.parsed.y,r=unsafeWindow.userscriptAvgSeasonEpisodeRatings;return e.datasetIndex===0?`${a/10}${r?.personal?.average?`  (avg: ${r.personal.average.toFixed(1)})`:""}`:e.datasetIndex===1?`${a}%  (${numFormatCompact.formatTLC(datasetsData[t].votes)} v.)${r?.general?`  (avg: ${r.general.average?Math.round(r.general.average):"--"}%)`:""}`:e.datasetIndex===2?`${numFormatCompact.formatTLC(a)}${datasetsData[0].watchers?`  (${Math.round(a*100/datasetsData[0].watchers)}%)`:""}`:`${a}`},labelColor:e=>({borderColor:e.dataset.borderColor(),backgroundColor:e.dataset.backgroundColor()}),footer:e=>{const t=datasetsData[e[0].parsed.x].releaseDate;return t?unsafeWindow.formatDate?.(t)||t:void 0}}},legend:{labels:{usePointStyle:!0,filter:(e,t)=>t.datasets[e.datasetIndex].data.some(a=>a!==null)}},filler:{propagate:!1},zoom:{zoom:{mode:"x",drag:{enabled:!0,threshold:0}},limits:{x:{minRange:8}}}}}}function addStyles(){GM_addStyle(`
#seasons-episodes-chart-wrapper {
  position: relative;
  margin-top: 20px;
  width: 100%;
  height: 250px;
}
@media (width <= 767px) {
  #seasons-episodes-chart-wrapper {
    margin-left: -10px;
    margin-right: -10px;
    width: calc(100% + 20px);
  }
}
@media (991px < width) {
  #seasons-episodes-chart-wrapper {
    height: 300px;
  }
}
  `)}